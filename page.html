<html>
  <head>
    <title>The crappy wikipedia quiz</title>
  </head>
  <body>
    <center>
      <h1>THE GREAT WIKIPEDIA QUIZ</h1>
    </center>
    <div id="loading">
      <p>What is your name?</p>
      <input id="nameInput" onsubmit=onSubmitNameClick() type="text"/>
      <button id="nameSubmit" onclick=onSubmitNameClick()>Submit</button>
    </div>
    <div id="playArea" hidden>
      <h2 id="topic">TOPIC FILLER</h3>
      <h3 id="subtopic">SUBTOPIC FILLER</h3>
      <p id="question">QUESTION FILLER</p>
      <button id="button0" onclick=onButtonClick(0)>BUTTON 1</button>
      <button id="button1" onclick=onButtonClick(1)>BUTTON 2</button>
      <button id="button2" onclick=onButtonClick(2)>BUTTON 3</button>
      <button id="button3" onclick=onButtonClick(3)>BUTTON 4</button>
      <div id="answerArea">
        <h2 id="correct" hidden>CORRECT!</h2>
        <h2 id="wrong" hidden>WRONG!</h2>
      </div>
      <div id="countdown">
        <h5>10</h5>
      </div>
      <div id="scoreboard">
        
      </div>
    </div>
  </body>
</html>

<script>
  const loadingElement = document.getElementById("loading");
  const playAreaElement = document.getElementById("playArea");

  const nameInput = document.getElementById("nameInput");
  const nameSubmit = document.getElementById("nameSubmit");

  const topicElement = document.getElementById("topic");
  const subtopicElement = document.getElementById("subtopic");
  const questionElement = document.getElementById("question");
  const scoreboardElement = document.getElementById("scoreboard");
  const countdownElement = document.getElementById("countdown");

  const buttonElements = [
    document.getElementById("button0"),
    document.getElementById("button1"),
    document.getElementById("button2"),
    document.getElementById("button3"),
  ];

  const correctElement = document.getElementById("correct");
  const wrongElement = document.getElementById("wrong");

  let correctAnswer;
  let playerName;
  let countdownValue;

  function onButtonClick(buttonNumber) {
    if (correctAnswer === buttonNumber) correctElement.removeAttribute("hidden")
    else wrongElement.removeAttribute("hidden");

    buttonElements.forEach(button => button.setAttribute("disabled", "true"));

    fetch("http://localhost:8080/answer_question", {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      // FIXME: really shouldn't trust the client to say the answer is right...
      body: JSON.stringify({ 
        name: playerName,
        correct: correctAnswer === buttonNumber, 
      })
    }); 
  }

  async function onSubmitNameClick() {
    const playerResp = await fetch("http://localhost:8080/join_game", {
      method: 'POST',
      headers: {
        'Accept': 'application/json',
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ name: nameInput.value })
    });
    loadingElement.setAttribute("hidden", "true");
    playArea.removeAttribute("hidden");
    playerName = nameInput.value;
  }

  function setQuestion(json) {
    topicElement.innerText = json.topic.replace(/_/g, " ");
    subtopicElement.innerText = json.section.replace(/_/g, " ");
    questionElement.innerText = json.question;

    buttonElements.forEach((button, i) => button.innerText = json.answers[i]);
    json.answers.forEach((answer, i) => {
      if (answer === json.correct_answer) correctAnswer = i;
    });
  }

  async function updateScoreboard() {
    const playersResp = await fetch("http://localhost:8080/get_players");
    const playerJson = await playersResp.json();
    scoreboardElement.innerHTML = "";
    playerJson.players.forEach(player => {
      const element = document.createElement("p");
      element.innerText = player.name + " " + player.score;
      scoreboardElement.appendChild(element);
    })
  }

  function refreshBoard() {
    correctElement.setAttribute("hidden", "true");
    wrongElement.setAttribute("hidden", "true");
    buttonElements.forEach((button, i) => button.removeAttribute("disabled"));
  }

  function startCountdownTimer() {
    setInterval(() => {
      countdownValue = countdownValue - 1;
      countdownElement.innerText = countdownValue;
    }, 1000);
  }

  async function getQuestionData() {
    const questionResp = await fetch("http://localhost:8080/get_current_question");
    const json = await questionResp.json();
    const activeQuestionStartTime = new Date(json["active_question_start_time"]);
    const questionTime = json["question_time"];
    const currentTime = new Date(new Date().toLocaleString("en-US", {timeZone: "UTC"}))
    activeQuestionStartTime.setSeconds(
      activeQuestionStartTime.getSeconds() + questionTime
    );

    return {
      json,
      currentTime,
      activeQuestionStartTime,
    };
  }

  function fetchNextQuestion(time) {
    setTimeout(async () => {
      const { json, activeQuestionStartTime, currentTime } = await getQuestionData();
      refreshBoard();
      updateScoreboard();
      countdownValue = json.question_time;
      setQuestion(json);
      fetchNextQuestion(activeQuestionStartTime.getTime() - currentTime.getTime())
    }, time)
  }

  async function setup() {
    const { json, activeQuestionStartTime, currentTime } = await getQuestionData();
    startCountdownTimer(activeQuestionStartTime, currentTime);
    setQuestion(json);
    updateScoreboard();
    fetchNextQuestion(activeQuestionStartTime.getTime() - currentTime.getTime());
  }

  setup();
</script>